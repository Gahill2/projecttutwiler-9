import os
from fastapi import FastAPI
from fastapi.responses import JSONResponse
from ingest import refresh_all, get_stats
from scheduler import start_scheduler, stop_scheduler

# Initialize Sentry if DSN is provided
def init_sentry(service_name: str):
    """Initialize Sentry if DSN is provided"""
    sentry_dsn = os.getenv("SENTRY_DSN")
    if not sentry_dsn:
        return None
    
    try:
        import sentry_sdk
        from sentry_sdk.integrations.fastapi import FastApiIntegration
        from sentry_sdk.integrations.logging import LoggingIntegration
        
        sentry_sdk.init(
            dsn=sentry_dsn,
            integrations=[
                FastApiIntegration(),
                LoggingIntegration(level=None, event_level=None),
            ],
            traces_sample_rate=1.0,
            environment=os.getenv("APP_ENV", "dev"),
            release=os.getenv("GIT_SHA"),
        )
        
        sentry_sdk.set_tag("service", service_name)
        return sentry_sdk
    except ImportError:
        return None

# Initialize Sentry if DSN is provided
init_sentry("cve-ingestor")

app = FastAPI(title="CVE Ingestor")

@app.on_event("startup")
async def startup_event():
    """Start background scheduler on startup"""
    start_scheduler()

@app.on_event("shutdown")
async def shutdown_event():
    """Stop background scheduler on shutdown"""
    stop_scheduler()

@app.get("/health")
async def health():
    return {"status": "ok"}

@app.get("/stats")
async def stats():
    """Get ingestion stats per namespace"""
    return {"namespaces": get_stats()}

@app.post("/refresh")
async def refresh():
    """Manually trigger refresh of all CVE sources"""
    try:
        results = refresh_all()
        return {
            "status": "success",
            "results": results
        }
    except Exception as e:
        return JSONResponse(
            status_code=500,
            content={"status": "error", "error": str(e)}
        )

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=9095)

