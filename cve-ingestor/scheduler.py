import os
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.interval import IntervalTrigger
from ingest import refresh_all

_scheduler = None

def start_scheduler():
    """Start background scheduler if CVE_AUTORUN is enabled"""
    autorun = os.getenv("CVE_AUTORUN", "false").lower() == "true"
    if not autorun:
        return None
    
    global _scheduler
    if _scheduler is not None:
        return _scheduler
    
    _scheduler = BackgroundScheduler()
    
    # Run every 6 hours
    _scheduler.add_job(
        func=refresh_all,
        trigger=IntervalTrigger(hours=6),
        id="refresh_cves",
        name="Refresh CVE data from all sources",
        replace_existing=True
    )
    
    _scheduler.start()
    return _scheduler

def stop_scheduler():
    """Stop background scheduler"""
    global _scheduler
    if _scheduler:
        _scheduler.shutdown()
        _scheduler = None

